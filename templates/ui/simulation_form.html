{% extends 'ui/base.html' %}

{% block title %}Nouvelle Simulation - {{ block.super }}{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'ui:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item active">Nouvelle Simulation</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0">üöÄ Cr√©er une Nouvelle Simulation</h3>
            </div>
            <div class="card-body">
                <form method="post" id="simulationForm">
                    {% csrf_token %}
                    
                    <!-- Configuration de base -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.scenario.id_for_label }}" class="form-label">
                                Sc√©nario <span class="text-danger">*</span>
                            </label>
                            {{ form.scenario }}
                            <div class="form-text">Type d'exp√©rience √† simuler</div>
                            {% if form.scenario.errors %}
                                <div class="text-danger">{{ form.scenario.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.n_steps.id_for_label }}" class="form-label">
                                Nombre d'√©tapes <span class="text-danger">*</span>
                            </label>
                            {{ form.n_steps }}
                            <div class="form-text">Dur√©e de la simulation (recommand√©: 100-500)</div>
                            {% if form.n_steps.errors %}
                                <div class="text-danger">{{ form.n_steps.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Configuration des agents -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.n_buyers.id_for_label }}" class="form-label">
                                Nombre d'acheteurs
                            </label>
                            {{ form.n_buyers }}
                            <div class="form-text">Agents qui placent des ordres d'achat</div>
                            {% if form.n_buyers.errors %}
                                <div class="text-danger">{{ form.n_buyers.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.n_sellers.id_for_label }}" class="form-label">
                                Nombre de vendeurs
                            </label>
                            {{ form.n_sellers }}
                            <div class="form-text">Agents qui placent des ordres de vente</div>
                            {% if form.n_sellers.errors %}
                                <div class="text-danger">{{ form.n_sellers.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Configuration avanc√©e -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.n_items.id_for_label }}" class="form-label">
                                Nombre d'objets
                            </label>
                            {{ form.n_items }}
                            <div class="form-text">Objets de collection disponibles</div>
                            {% if form.n_items.errors %}
                                <div class="text-danger">{{ form.n_items.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.seed.id_for_label }}" class="form-label">
                                Graine al√©atoire
                            </label>
                            {{ form.seed }}
                            <div class="form-text">Pour reproduire les r√©sultats (optionnel)</div>
                            {% if form.seed.errors %}
                                <div class="text-danger">{{ form.seed.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Description des sc√©narios -->
                    <div class="mb-4">
                        <h5>üìã Description des Sc√©narios</h5>
                        <div class="accordion" id="scenarioAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="baselineHead">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#baselineCollapse">
                                        Baseline - Simulation Standard
                                    </button>
                                </h2>
                                <div id="baselineCollapse" class="accordion-collapse collapse" data-bs-parent="#scenarioAccordion">
                                    <div class="accordion-body">
                                        <p>Simulation normale sans √©v√©nements externes particuliers. Les agents agissent selon leur comportement par d√©faut.</p>
                                        <ul>
                                            <li>Comportements d'agents standards</li>
                                            <li>Pas d'interventions de march√©</li>
                                            <li>Id√©al pour √©tablir une r√©f√©rence</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="demandHead">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#demandCollapse">
                                        Demand x2 - Doublement de la Demande
                                    </button>
                                </h2>
                                <div id="demandCollapse" class="accordion-collapse collapse" data-bs-parent="#scenarioAccordion">
                                    <div class="accordion-body">
                                        <p>Simule un √©v√©nement qui double la demande √† mi-parcours de la simulation.</p>
                                        <ul>
                                            <li>Activation vers l'√©tape 50</li>
                                            <li>Dur√©e : 30 √©tapes environ</li>
                                            <li>Observe l'impact sur les prix</li>
                                            <li>Test de r√©silience du march√©</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Estimation du temps -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-clock"></i> Estimation du temps d'ex√©cution</h6>
                        <p class="mb-0">
                            <span id="estimatedTime">~2-5 minutes</span> selon la configuration.
                            Les simulations s'ex√©cutent en arri√®re-plan.
                        </p>
                    </div>
                    
                    <!-- Boutons -->
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'ui:dashboard' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Retour
                        </a>
                        
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-play"></i> Lancer la Simulation
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Aide contextuelle -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">üí° Conseils pour votre Simulation</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Param√®tres Recommand√©s</h6>
                        <ul class="small">
                            <li><strong>D√©butant:</strong> 100 √©tapes, 30 agents</li>
                            <li><strong>Standard:</strong> 200 √©tapes, 50 agents</li>
                            <li><strong>Avanc√©:</strong> 500+ √©tapes, 100+ agents</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>√Ä Observer</h6>
                        <ul class="small">
                            <li>√âvolution des prix au fil du temps</li>
                            <li>Volume des transactions</li>
                            <li>Comportement lors d'√©v√©nements</li>
                            <li>Stabilit√© du march√©</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Estimation dynamique du temps
    function updateEstimation() {
        const steps = parseInt(document.getElementById('{{ form.n_steps.id_for_label }}').value) || 100;
        const buyers = parseInt(document.getElementById('{{ form.n_buyers.id_for_label }}').value) || 30;
        const sellers = parseInt(document.getElementById('{{ form.n_sellers.id_for_label }}').value) || 20;
        
        const totalAgents = buyers + sellers;
        const estimatedSeconds = (steps * totalAgents) / 100; // Estimation approximative
        
        let timeText;
        if (estimatedSeconds < 60) {
            timeText = `~${Math.ceil(estimatedSeconds)} secondes`;
        } else if (estimatedSeconds < 3600) {
            timeText = `~${Math.ceil(estimatedSeconds / 60)} minutes`;
        } else {
            timeText = `~${Math.ceil(estimatedSeconds / 3600)} heures`;
        }
        
        document.getElementById('estimatedTime').textContent = timeText;
    }
    
    // Mise √† jour de l'estimation quand les valeurs changent
    ['{{ form.n_steps.id_for_label }}', '{{ form.n_buyers.id_for_label }}', '{{ form.n_sellers.id_for_label }}'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateEstimation);
    });
    
    // Estimation initiale
    updateEstimation();
    
    // Confirmation avant soumission pour les grandes simulations
    document.getElementById('simulationForm').addEventListener('submit', function(e) {
        const steps = parseInt(document.getElementById('{{ form.n_steps.id_for_label }}').value) || 100;
        const totalAgents = (parseInt(document.getElementById('{{ form.n_buyers.id_for_label }}').value) || 30) + 
                           (parseInt(document.getElementById('{{ form.n_sellers.id_for_label }}').value) || 20);
        
        if (steps > 1000 || totalAgents > 200) {
            if (!confirm('Cette simulation pourrait prendre beaucoup de temps. Continuer ?')) {
                e.preventDefault();
                return false;
            }
        }
        
        // D√©sactive le bouton pour √©viter les double-soumissions
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('submitBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Lancement...';
    });
</script>
{% endblock %}